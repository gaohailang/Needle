<!DOCTYPE html>
<html>
<head>
    <title>Needel - A lightweight JSON data operation tool</title>

    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

    <link rel="stylesheet" href="//static.wdjimg.com/ajax/libs/jsoneditor/3.1.0/jsoneditor.min.css">
    <link rel="stylesheet" href="//static.wdjimg.com/ajax/libs/twitter-bootstrap/3.2.0/css/bootstrap.min.css">

    <style type="text/css">
        #jsoneditor-add,
        #jsoneditor-edit {
            height: 500px;
        }
    </style>
</head>

<body>
    <div class="jumbotron">
        <div class="container">
            <h2>Needel</h2>
        </div>
    </div>
    <div class="container">
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>URL</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody class="list-table-body">
            </tbody>
        </table>
        <button type="button" class="btn btn-primary" class="btn-add" data-toggle="modal" data-target="#add-modal">Add...</button>
    </div>

    <div id="add-modal" class="modal fade">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                    <h4 class="modal-title">Add a new JSON source</h4>
                </div>
                    <div class="modal-body">
                        <form class="form-horizontal" role="form">
                            <div class="form-group">
                                <label for="add-name-input" class="col-sm-2 control-label">Name</label>
                                <div class="col-sm-10">
                                    <input id="add-name-input" type="text" class="form-control" placeholder="Name of this source" />
                                </div>
                            </div>
                        </form>
                        <div id="jsoneditor-add"></div>
                    </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary btn-save">Save</button>
                </div>
            </div>
        </div>
    </div>

    <div id="edit-modal" class="modal fade">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                    <h4 class="modal-title">Add a new JSON source</h4>
                </div>
                    <div class="modal-body">
                        <form class="form-horizontal" role="form">
                            <div class="form-group">
                                <label for="edit-name-input" class="col-sm-2 control-label">Name</label>
                                <div class="col-sm-10">
                                    <input id="edit-name-input" type="text" class="form-control" placeholder="Name of this source" />
                                </div>
                            </div>
                            <input id="edit-id-input" type="hidden" value="" />
                        </form>
                        <div id="jsoneditor-edit"></div>
                    </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary btn-update">Save</button>
                </div>
            </div>
        </div>
    </div>

    <script type="text/x-template" id="tmpl-item">
        <tr>
            <td>{{ name }}</td>
            <td><a class="btn-delete" href="{{ location.protocol + '//' + location.host + '/source/' + id }}">{{ location.protocol + '//' + location.host + '/needle/source/' + id }}</a></td>
            <td>
                <a href="#" class="btn-delete" data-id="{{ id }}">Delete</a>
                <a href="#" class="btn-edit" data-id="{{ id }}">Edit</a>
            </td>
        </tr>
    </script>

    <script src="//static.wdjimg.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
    <script src="//static.wdjimg.com/ajax/libs/twitter-bootstrap/3.2.0/js/bootstrap.min.js"></script>
    <script src="//static.wdjimg.com/ajax/libs/jsoneditor/3.1.0/jsoneditor.min.js"></script>
    <script src="//static.wdjimg.com/ajax/libs/ace/1.1.3/ace.js"></script>
    <script src="//static.wdjimg.com/ajax/libs/underscore.js/1.6.0/underscore-min.js"></script>
    <script>
    $(function () {
        var editFlag =

        _.templateSettings = {
            interpolate: /\{\{(.+?)\}\}/g
        };

        var itemTemplate = _.template($('#tmpl-item').html());

        var renderList = function () {
            $.ajax('/needle/source').done(function (resp) {
                var fragment = document.createDocumentFragment();
                _.each(resp, function (source) {
                    fragment.appendChild($(itemTemplate(source))[0]);
                });

                $('.list-table-body').html(fragment);
            });
        };

        var editor = new JSONEditor(document.getElementById('jsoneditor-add'), {
            mode: 'code',
            modes: ['code', 'tree']
        }, {});

        var editor2 = new JSONEditor(document.getElementById('jsoneditor-edit'), {
            mode: 'code',
            modes: ['code', 'tree']
        }, {});

        $(document).on('click', '.btn-save', function () {
            var name = $('#add-name-input').val().trim();

            if (!name) {
                $('#add-name-input').focus();
            } else {
                $('#add-modal').modal('hide');

                $.ajax({
                    method: 'POST',
                    url: '/needle/source',
                    data: {
                        name: name,
                        body: editor.getText()
                    },
                    success: function (res) {
                        $('#add-name-input').val('');
                        editor.setText('');
                        renderList();
                    },
                    error: function () {}
                });
            }
        });

        $(document).on('click', '.btn-update', function () {
            var name = $('#edit-name-input').val().trim();

            if (!name) {
                $('#edit-name-input').focus();
            } else {
                $('#edit-modal').modal('hide');

                $.ajax({
                    method: 'PUT',
                    url: '/needle/source/' + $('#edit-id-input').val(),
                    data: {
                        name: name,
                        body: editor2.getText()
                    },
                    success: function (res) {
                        $('#edit-name-input').val('');
                        $('#edit-id-input').val('');
                        editor2.setText('');
                        renderList();
                    },
                    error: function () {}
                });
            }
        });

        $(document).on('click', '.btn-delete', function (evt) {
            $.ajax({
                url: '/needle/source/' + $(evt.originalEvent.srcElement).data('id'),
                success: function (resp) {
                    var del = confirm('Confirm to delete ' + resp.name + '?');
                    if (del) {
                        $.ajax({
                            method: 'DELETE',
                            url: '/source/' + resp.id,
                            success: function () {
                                renderList();
                            }
                        });
                    }
                }
            });
        });

        $(document).on('click', '.btn-edit', function (evt) {
            $.ajax({
                url: '/needle/source/' + $(evt.originalEvent.srcElement).data('id'),
                success: function (resp) {
                    $('#edit-name-input').val(resp.name);
                    $('#edit-id-input').val(resp.id);
                    editor2.setText(resp.body);

                    $('#edit-modal').modal('show');
                }
            });
        });

        renderList();
    });
    </script>
</body>
</html>
